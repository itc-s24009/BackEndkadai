extends ../layout

prepend head
    - const title = '出版社管理'

block header
    h1(class=['text-3xl', 'font-light', 'mb-6']) 出版社管理 (管理者用)

block content
    // --- 新規登録フォーム ---
    div(class="bg-blue-50 border border-blue-200 p-6 rounded shadow-sm mb-8")
        h2(class="text-xl font-bold mb-4 text-black") 新規登録
        form(action="/admin/publisher" method="POST" class="flex gap-4 items-center")
            label(class="font-bold text-gray-700 w-32") 出版社名:
            input(
                type="text"
                name="name"
                placeholder="新しい出版社の名前を入力"
                required
                class="flex-1 border border-gray-300 p-2 rounded focus:outline-none focus:border-blue-500 text-black bg-white"
            )
            button(
                type="submit"
                class="bg-blue-600 text-white px-8 py-2 rounded hover:bg-blue-700 transition shadow font-bold"
            ) 登録

    // --- 一覧表示 ---
    div(class="grid gap-2")
        h3(class="text-lg font-semibold text-gray-700 mb-2") 登録済み出版社一覧
        if publishers.length === 0
            div(class="bg-white border p-4 rounded text-center text-gray-500") 出版社はまだ登録されていません
        else
            each pub in publishers
                div(class="bg-white border border-gray-200 p-4 rounded flex justify-between items-center shadow-sm hover:shadow transition")
                    // 名前 (クリックで編集モーダルを開く)
                    div(class="flex items-center gap-3")
                        span(class="text-xs text-gray-400 font-mono") ID: #{pub.id.substring(0,8)}...

                        button(
                            type="button"
                            onclick=`openEditModal('${pub.id}', '${pub.name}')`
                            class="text-lg font-medium text-blue-900 hover:text-blue-600 hover:underline text-left"
                            title="クリックして編集"
                        )
                            | #{pub.name}

                    // 削除ボタン
                    button(
                        type="button"
                        onclick=`deletePublisher('${pub.id}')`
                        class="text-red-500 border border-red-200 bg-red-50 px-3 py-1 rounded text-sm hover:bg-red-600 hover:text-white transition"
                    ) 削除

    // --- 編集用ポップアップ (モーダル) ---
    div(id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-50 transition-opacity")
        div(class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-4")
            h2(class="text-2xl font-bold mb-6 text-gray-800") 出版社名の編集

            div(class="mb-4 p-3 bg-gray-100 rounded")
                p(class="text-sm text-gray-500 mb-1") 現在の名前
                p(id="currentNameDisplay" class="font-bold text-lg text-gray-800") --

            div(class="mb-6")
                label(for="editNameInput" class="block text-sm font-medium text-gray-700 mb-2") 新しい名前
                input(
                    type="text"
                    id="editNameInput"
                    class="w-full border p-3 rounded text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-black"
                    placeholder="出版社名を入力"
                )
                input(type="hidden" id="editIdInput")

            div(class="flex justify-end gap-3")
                button(type="button" onclick="closeModal()" class="px-5 py-2 rounded text-gray-600 hover:bg-gray-100 transition") キャンセル
                button(type="button" onclick="submitUpdate()" class="px-6 py-2 bg-green-600 text-white rounded font-bold hover:bg-green-700 transition shadow") 更新する

    // --- JSスクリプト ---
    script.
        function openEditModal(id, currentName) {
            document.getElementById('currentNameDisplay').textContent = currentName;
            document.getElementById('editNameInput').value = currentName;
            document.getElementById('editIdInput').value = id;
            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        async function submitUpdate() {
            const id = document.getElementById('editIdInput').value;
            const name = document.getElementById('editNameInput').value;

            if (!name) return alert("名前を入力してください");

            try {
                // 仕様通り POST /admin/publisher ではなく PUT で送信
                const res = await fetch('/admin/publisher', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id, name })
                });

                if(res.ok) {
                    alert('更新しました');
                    location.reload();
                } else {
                    alert('更新に失敗しました');
                }
            } catch(e) { console.error(e); alert('通信エラー'); }
        }

        async function deletePublisher(id) {
            if(!confirm('本当に削除しますか？\n（取り消せません）')) return;

            try {
                const res = await fetch('/admin/publisher', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id })
                });

                if(res.ok) {
                    alert('削除しました');
                    location.reload();
                } else {
                    alert('削除に失敗しました');
                }
            } catch(e) { console.error(e); alert('通信エラー'); }
        }