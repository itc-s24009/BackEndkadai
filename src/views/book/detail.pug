extends ../layout

prepend head
    - const title = book ? `詳細: ${book.title}` : '書籍詳細'

block header
    h1(class=['text-3xl', 'font-light', 'mb-6']) 書籍詳細情報

block content
    div(class="max-w-2xl mx-auto bg-white p-8 rounded shadow-lg border relative")

        // 書籍タイトル
        h2(class="text-4xl font-bold mb-6 text-gray-800")= book.title

        // 詳細情報リスト
        dl(class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-6")

            div
                dt(class="text-sm font-semibold text-gray-500 uppercase tracking-wider") ISBN
                dd(class="mt-1 text-lg text-gray-900")= book.isbn

            div
                dt(class="text-sm font-semibold text-gray-500 uppercase tracking-wider") 出版年月
                dd(class="mt-1 text-lg text-gray-900")= book.publication_year_month

            div(class="md:col-span-2 border-t pt-4")
                dt(class="text-sm font-semibold text-gray-500 uppercase tracking-wider") 著者
                dd(class="mt-1 text-xl text-gray-900 font-medium")= book.author.name

            div(class="md:col-span-2 border-t pt-4")
                dt(class="text-sm font-semibold text-gray-500 uppercase tracking-wider") 出版社
                dd(class="mt-1 text-xl text-gray-900 font-medium")= book.publisher.name

        // ボタン類
        div(class="mt-10 flex gap-4")
            // 戻るボタン
            a(href="/book/list" class="px-6 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition")
                | 一覧に戻る

            // 貸出ボタン (条件分岐)
            if book.is_rental
                // ★貸出中の場合（赤色・無効化）
                button(
                    type="button"
                    class="px-6 py-2 bg-red-600 text-white rounded cursor-not-allowed opacity-70"
                    disabled
                ) 貸出中
            else
                // ★貸出可能な場合（緑色）
                button(
                    type="button"
                    onclick=`rentalBook('${book.isbn}')`
                    class="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition"
                ) 貸出する


    // 一覧画面と同様の貸出用スクリプト
    script.
        async function rentalBook(isbn) {
            if (!confirm('この本を借りますか？')) return;
            try {
                const res = await fetch('/book/rental', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({book_id: isbn})
                });
                const result = await res.json();
                if (res.ok) {
                    alert('貸出完了！期限: ' + new Date(result.due_date).toLocaleDateString());
                    window.location.href = '/users/history';
                } else {
                    alert('エラー: ' + (result.message || '予期せぬエラー'));
                }
            } catch (e) {
                console.error(e);
                alert('通信エラー');
            }
        }