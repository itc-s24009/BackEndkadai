extends ../layout

prepend head
    - const title = '書籍一覧'

block header
    div(class="flex flex-col md:flex-row justify-between items-center mb-6")
        h1(class=['text-4xl', 'font-light', 'text-black']) 書籍一覧

        // ▼ ナビゲーションボタン群
        div(class="flex flex-wrap gap-2 mt-4 md:mt-0")
            a(href="/users/return" class="bg-orange-500 text-white px-4 py-2 rounded text-sm hover:bg-orange-600 transition font-bold") 返却する
            a(href="/users/history" class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition font-bold") 履歴
            a(href="/users/change" class="bg-gray-200 text-black border border-black px-4 py-2 rounded text-sm hover:bg-gray-300 transition font-bold") 設定
            a(href="/users/login" class="bg-black text-white px-4 py-2 rounded text-sm hover:bg-gray-800 transition font-bold") ログアウト

block content
    // --- 検索エリア (追加) ---
    div(class="bg-gray-100 p-4 rounded border border-black mb-8 flex flex-col md:flex-row gap-4 items-end md:items-center")
        div(class="flex-1 w-full")
            label(class="block text-xs font-bold mb-1 text-black") 検索種別
            select(id="searchType" class="border border-black p-2 rounded w-full text-black bg-white")
                option(value="author" class="text-black") 著者名を検索
                option(value="publisher" class="text-black") 出版社名を検索

        div(class="flex-[2] w-full")
            label(class="block text-xs font-bold mb-1 text-black") キーワード
            input(type="text" id="searchKeyword" placeholder="検索ワードを入力" class="border border-black p-2 rounded w-full text-black placeholder-gray-500")

        div
            button(type="button" onclick="performSearch()" class="bg-black text-white px-6 py-2 rounded font-bold hover:bg-gray-800 transition w-full md:w-auto border border-black") 検索

    // --- 検索結果表示エリア (初期は非表示) ---
    div(id="searchResultArea" class="hidden mb-8 border border-black bg-white p-4 rounded")
        h3(class="font-bold text-black mb-2") 検索結果:
        ul(id="searchResultList" class="list-disc ml-5 space-y-1 text-sm text-black")
            // ここにJSで結果が挿入されます


    // --- メインの書籍リスト ---
    if data.books.length === 0
        p(class="text-black font-bold") 表示できる書籍がありません。
    else
        div(class="grid gap-6")
            each book in data.books
                div(class="bg-white border border-black p-6 rounded shadow-sm hover:shadow-md transition relative")
                    h2(class="text-2xl font-bold mb-2")
                        // ▼ リンク文字色を黒に固定、下線ホバーだけ残す
                        a(href=`/book/detail/${book.isbn}` class="text-black hover:underline")
                            = book.title

                    div(class="text-sm text-black space-y-1 mb-4")
                        p
                            span(class="font-bold text-black") ISBN:
                            | #{book.isbn}
                        p
                            span(class="font-bold text-black") 著者:
                            | #{book.author.name}
                        p
                            span(class="font-bold text-black") 出版年月:
                            | #{book.publication_year_month}

    // ページネーション
    div(class="flex justify-center items-center gap-4 mt-8 text-black")
        if data.current > 1
            a(href=`/book/list/${data.current - 1}` class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold") &laquo; 前へ
        else
            span(class="px-4 py-2 bg-gray-200 text-gray-500 rounded cursor-not-allowed border border-gray-300 font-bold") &laquo; 前へ

        span(class="font-mono text-lg font-bold text-black") #{data.current} / #{data.last_page}

        if data.current < data.last_page
            a(href=`/book/list/${data.current + 1}` class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-bold") 次へ &raquo;
        else
            span(class="px-4 py-2 bg-gray-200 text-gray-500 rounded cursor-not-allowed border border-gray-300 font-bold") 次へ &raquo;


    // --- 検索動作用スクリプト ---
    script.
        async function performSearch() {
            const type = document.getElementById('searchType').value;
            const keyword = document.getElementById('searchKeyword').value;
            const resultArea = document.getElementById('searchResultArea');
            const resultList = document.getElementById('searchResultList');

            if (!keyword) {
                resultArea.classList.add('hidden');
                return;
            }

            try {
                // ブリッジAPIにPOSTで問い合わせ (JSからはJSON Body送信可能)
                const res = await fetch('/book/search/internal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, keyword })
                });

                if (!res.ok) throw new Error('Search failed');

                const data = await res.json();
                const items = data.results || [];

                resultList.innerHTML = '';
                if (items.length === 0) {
                    resultList.innerHTML = '<li class="text-black font-bold list-none">該当なし</li>';
                } else {
                    items.forEach(item => {
                        const li = document.createElement('li');
                        li.textContent = item.name + ' (ID: ' + item.id.substring(0,8) + '...)';
                        li.className = "text-black"; // 文字色黒
                        resultList.appendChild(li);
                    });
                }

                resultArea.classList.remove('hidden');

            } catch (e) {
                console.error(e);
                alert('検索エラー');
            }
        }