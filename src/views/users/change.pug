extends ../layout

prepend head
    - const title = '名前変更'

block header
    h1(class=['text-4xl', 'font-light', 'mb-6']) 名前変更

block content
    div(class="max-w-md mx-auto bg-white p-8 rounded shadow-md")
        p(class="mb-4 text-gray-600") 新しいお名前を入力してください。

        form(id="changeNameForm" onsubmit="return false;")
            .form-group.mb-6
                label(for="name" class="block text-sm font-medium text-gray-700 mb-2") 新しい名前
                input(
                    type="text"
                    id="name"
                    name="name"
                    value=userName
                    required
                    class="w-full px-3 py-2 border rounded focus:outline-none focus:ring focus:border-blue-300"
                )

            button(
                type="button"
                onclick="submitChange()"
                class="w-full bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition"
            ) 更新する

    // 戻るリンク
    div(class="mt-4 text-center")
        a(href="/book/list/1" class="text-blue-600 hover:underline") ← Bookに戻る

    // ▼ JavaScript (PUT送信)
    script.
        async function submitChange() {
            const nameInput = document.getElementById('name');
            const newName = nameInput.value;

            if(!newName) return;

            try {
                // 仕様通り JSON body で PUT メソッドを送る
                const res = await fetch('/users/change', {
                    method: 'PUT', // ここが重要
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newName })
                });

                const data = await res.json();

                if (res.ok) {
                    // 200 OK
                    alert(data.message); // "更新しました"
                    // 必要ならリダイレクト
                    window.location.href = '/book/list/1';
                } else {
                    // 400 or 500 Error
                    alert('エラー: ' + (data.reason || '不明なエラー'));
                }
            } catch (err) {
                console.error(err);
                alert('通信エラーが発生しました');
            }
        }